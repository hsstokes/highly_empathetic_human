<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Animated Character</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
        }
        canvas {
            display: block;
        }
        #startOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #startButton {
            padding: 20px 40px;
            font-size: 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .control-button {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: rgba(255,255,255,0.3);
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: #555;
            user-select: none;
            -webkit-user-select: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .control-button:active {
            background-color: rgba(200,200,200,0.5);
        }
        #soundButton {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background-color: rgba(255,255,255,0.3);
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: #555;
            user-select: none;
            -webkit-user-select: none;
            z-index: 100;
        }
        #soundButton:active {
            background-color: rgba(200,200,200,0.5);
        }
    </style>
</head>
<body>
    <div id="startOverlay">
        <button id="startButton">TAP TO START</button>
    </div>
    <div id="soundButton">●</div>

    <script>
        // Game variables
        let walkRight = [];
        let walkLeft = [];
        let gridImg;
        let bulletSound, hitSound;
        let bullets = [];
        let shoot = 0;
        let gameStarted = false;
        let soundsLoaded = false;
        let soundInitialized = false;
        
        // Mobile controls
        let leftButton, rightButton, upButton, downButton;
        
        // Canvas dimensions
        const W_WIDTH = 600;
        const W_HEIGHT = 600;
        
        // Player class
        class Player {
            constructor(x, y, width, height) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.vel = 4;
                this.is_jump = false;
                this.jump_count = 10;
                this.left = false;
                this.right = false;
                this.up = false;
                this.down = false;
                this.walkCount = 0;
                this.standing = true;
                this.last_direction = "right";
                this.hitbox = {
                    x: this.x + 75,
                    y: this.y + 75,
                    width: this.width - 150,
                    height: this.height - 150
                };
            }
            
            draw() {
                let frames;
                if (this.right || this.last_direction === "right") {
                    frames = walkRight;
                } else {
                    frames = walkLeft;
                }
                
                if (this.walkCount >= frames.length) {
                    this.walkCount = 0;
                }
                
                // Use raw canvas API for multiply blend mode
                let ctx = drawingContext;
                ctx.save();
                ctx.globalCompositeOperation = 'multiply';
                ctx.globalAlpha = 0.9;
                
                // Draw the frame at exact dimensions
                if (frames[this.walkCount] && frames[this.walkCount].canvas) {
                    ctx.drawImage(frames[this.walkCount].canvas, this.x, this.y, this.width, this.height);
                }
                
                // Restore canvas state
                ctx.restore();
                
                this.walkCount += 1;
                if (this.walkCount >= frames.length) {
                    this.walkCount = 0;
                }
                
                // Update hitbox with current position
                this.hitbox = {
                    x: this.x + 75,
                    y: this.y + 75,
                    width: this.width - 150,
                    height: this.height - 150
                };
            }
            
            move() {
                // Movement logic is now in its own function
                if (this.left && this.x > 0) {
                    this.x -= this.vel;
                    this.last_direction = "left";
                    this.standing = false;
                } 
                else if (this.right && this.x < width - this.width) {
                    this.x += this.vel;
                    this.last_direction = "right";
                    this.standing = false;
                }
                else {
                    this.standing = true;
                }
                
                // Handle jumping mechanics
                if (this.is_jump) {
                    if (this.jump_count >= -10) {
                        const neg = this.jump_count < 0 ? -1 : 1;
                        this.y -= (this.jump_count ** 2) * neg * 0.5;
                        this.jump_count -= 1;
                    } else {
                        this.is_jump = false;
                        this.jump_count = 10;
                    }
                }
                
                // Handle down movement when not jumping
                if (this.down && !this.is_jump && this.y < height - this.height) {
                    this.y += this.vel;
                }
            }
        }
        
        // Circle effect (beautiful random circles)
        class Projectile {
            constructor(x, y, radius, colour, direction) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.colour = colour;
                this.direction = direction;
                
                // Random velocity components
                const angle = random(0, TWO_PI);
                const speed = random(2, 8);
                this.velX = speed * cos(angle);
                this.velY = speed * sin(angle);
                
                // Random lifetime
                this.lifetime = random(30, 120);
                this.age = 0;
                this.growing = true;
                this.maxRadius = radius * random(2, 5);
            }
            
            draw() {
                // Draw the circle
                noStroke();
                const alpha = map(this.age, 0, this.lifetime, 255, 0);
                fill(red(this.colour), green(this.colour), blue(this.colour), alpha);
                circle(this.x, this.y, this.radius * 2);
                
                // Update position
                this.x += this.velX;
                this.y += this.velY;
                
                // Update size
                if (this.growing) {
                    this.radius += 0.2;
                    if (this.radius >= this.maxRadius) {
                        this.growing = false;
                    }
                } else {
                    this.radius = max(0, this.radius - 0.05);
                }
                
                // Update age
                this.age++;
            }
            
            isFinished() {
                return this.age >= this.lifetime;
            }
        }
        
        // Preload assets
        function preload() {
            // Load background
            gridImg = loadImage('images/grid_img.jpeg');
            
            // Load character images
            for (let i = 1; i <= 6; i++) {
                walkRight.push(loadImage(`soldier/${i}.png`));
                walkLeft.push(loadImage(`soldier/L${i}.png`));
            }
            
            // Sound loading
            soundFormats('mp3', 'ogg');
            bulletSound = loadSound('sounds/Bulletsound.mp3');
            hitSound = loadSound('sounds/Hit.mp3');
        }
        
        function setup() {
            // Create canvas matching game dimensions
            let canvas;
            if (windowWidth / windowHeight > W_WIDTH / W_HEIGHT) {
                canvas = createCanvas(windowHeight * (W_WIDTH / W_HEIGHT), windowHeight);
            } else {
                canvas = createCanvas(windowWidth, windowWidth * (W_HEIGHT / W_WIDTH));
            }
            
            // Create character with smaller size
            soldier = new Player(width/2 - 75, height/2 - 75, 150, 150);
            
            // Set up start button
            document.getElementById('startButton').addEventListener('click', startGame);
            document.getElementById('startButton').addEventListener('touchstart', function(e) {
                startGame();
                e.preventDefault();
            });
            
            // Sound button for mobiles
            document.getElementById('soundButton').addEventListener('click', createCircles);
            document.getElementById('soundButton').addEventListener('touchstart', function(e) {
                createCircles();
                e.preventDefault();
            });
            
            // Create mobile control elements
            createMobileControls();
            
            frameRate(24); // Smoother framerate
            
            // Create AudioContext
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            try {
                window.audioContext = new AudioContext();
            } catch(e) {
                console.error("Could not create AudioContext:", e);
            }
        }
        
        function createMobileControls() {
            // Create control buttons with direct DOM manipulation
            leftButton = createElement('div', '←');
            leftButton.class('control-button');
            leftButton.position(20, height - 70);
            document.body.appendChild(leftButton.elt);
            
            rightButton = createElement('div', '→');
            rightButton.class('control-button');
            rightButton.position(width - 70, height - 70);
            document.body.appendChild(rightButton.elt);
            
            upButton = createElement('div', '↑');
            upButton.class('control-button');
            upButton.position(width/2 - 25, height - 140);
            document.body.appendChild(upButton.elt);
            
            downButton = createElement('div', '↓');
            downButton.class('control-button');
            downButton.position(width/2 - 25, height - 70);
            document.body.appendChild(downButton.elt);
            
            // Add direct event listeners with different approach
            setupMobileTouchHandlers();
            
            // Hide controls until game starts
            hideControls();
        }
        
        function hideControls() {
            leftButton.style('display', 'none');
            rightButton.style('display', 'none');
            upButton.style('display', 'none');
            downButton.style('display', 'none');
            document.getElementById('soundButton').style.display = 'none';
        }
        
        function showControls() {
            leftButton.style('display', 'flex');
            rightButton.style('display', 'flex');
            upButton.style('display', 'flex');
            downButton.style('display', 'flex');
            document.getElementById('soundButton').style.display = 'flex';
        }
        
        function setupMobileTouchHandlers() {
            // Left button - using direct DOM events
            leftButton.elt.ontouchstart = function(e) {
                soldier.left = true;
                soldier.right = false;
                e.preventDefault();
            };
            
            leftButton.elt.ontouchend = function() {
                soldier.left = false;
            };
            
            // Right button
            rightButton.elt.ontouchstart = function(e) {
                soldier.right = true;
                soldier.left = false;
                e.preventDefault();
            };
            
            rightButton.elt.ontouchend = function() {
                soldier.right = false;
            };
            
            // Up button
            upButton.elt.ontouchstart = function(e) {
                if (!soldier.is_jump) {
                    soldier.is_jump = true;
                }
                e.preventDefault();
            };
            
            // Down button
            downButton.elt.ontouchstart = function(e) {
                soldier.down = true;
                e.preventDefault();
            };
            
            downButton.elt.ontouchend = function() {
                soldier.down = false;
            };
            
            // Sound button
            document.getElementById('soundButton').ontouchstart = function(e) {
                createCircles();
                e.preventDefault();
            };
        }
        
        function startGame() {
            // Remove overlay
            document.getElementById('startOverlay').style.display = 'none';
            
            // Resume AudioContext if suspended
            if (window.audioContext && window.audioContext.state === 'suspended') {
                window.audioContext.resume();
            }
            
            // Try to unlock audio on iOS
            unlockAudio();
            
            // Initialize sounds
            initSounds();
            
            // Show mobile controls
            showControls();
            
            // Start the game
            gameStarted = true;
        }
        
        // Function to unlock audio on iOS
        function unlockAudio() {
            // Play silent audio to unlock
            const audioElement = document.createElement('audio');
            audioElement.setAttribute('src', 'data:audio/mp3;base64,SUQzAwAAAAAAIlRJVDIAAAABAAAASVRTUwAAAAEAAABUQ09OAAAABAAAAE11c2ljLw==');
            audioElement.setAttribute('playsinline', 'true');
            audioElement.play();
            
            // Create and play a silent oscillator
            if (window.audioContext) {
                const oscillator = window.audioContext.createOscillator();
                const gainNode = window.audioContext.createGain();
                gainNode.gain.value = 0;
                oscillator.connect(gainNode);
                gainNode.connect(window.audioContext.destination);
                oscillator.start(0);
                oscillator.stop(0.001);
            }
        }
        
        function initSounds() {
            try {
                // Force audio context to start
                if (window.audioContext && window.audioContext.state === 'suspended') {
                    window.audioContext.resume().then(() => {
                        console.log("AudioContext resumed by initSounds()");
                    });
                }
                
                // Add a direct HTML5 audio for fallback
                if (!window.backupAudio) {
                    window.backupAudio = new Audio();
                    window.backupAudio.src = 'sounds/Bulletsound.mp3';
                    window.backupAudio.load();
                }
                
                // Try playing with p5.sound
                if (bulletSound && typeof bulletSound.play === 'function') {
                    bulletSound.play();
                    bulletSound.stop();
                }
                
                if (hitSound && typeof hitSound.play === 'function') {
                    hitSound.play();
                    hitSound.stop();
                }
                
                soundsLoaded = true;
                soundInitialized = true;
            } catch(e) {
                console.error("Sound initialization failed:", e);
            }
        }
        
        function createCircles() {
            // Make multiple attempts to play sound
            playSound();
            
            // Create multiple beautiful random circles
            const numCircles = random(3, 8);
            const centerX = soldier.x + soldier.width / 2;
            const centerY = soldier.y + soldier.height / 2;
            
            for (let i = 0; i < numCircles; i++) {
                const size = random(4, 10);
                // Use a variety of green/blue colors
                const circleColor = color(
                    random(0, 50),  // low red
                    random(100, 200), // high green
                    random(50, 150)  // medium blue
                );
                
                bullets.push(new Projectile(
                    centerX + random(-10, 10),
                    centerY + random(-10, 10),
                    size, 
                    circleColor,
                    1
                ));
            }
            
            // Set cooldown
            shoot = 1;
        }
        
        function playSound() {
            // Multiple approaches to try to play sound
            try {
                // Approach 1: Use p5.sound
                if (soundsLoaded) {
                    if (window.audioContext && window.audioContext.state === 'suspended') {
                        window.audioContext.resume();
                    }
                    
                    if (bulletSound && typeof bulletSound.play === 'function') {
                        bulletSound.play();
                    }
                    
                    if (hitSound && typeof hitSound.play === 'function') {
                        hitSound.play();
                    }
                }
                
                // Approach 2: Use direct HTML5 Audio API as fallback
                if (window.backupAudio) {
                    window.backupAudio.currentTime = 0;
                    window.backupAudio.play().catch(e => console.log("HTML5 Audio fallback failed:", e));
                }
                
                // Approach 3: Create a new Audio element each time (works on some mobile browsers)
                const audio = new Audio('sounds/Bulletsound.mp3');
                audio.play().catch(e => console.log("New Audio element failed:", e));
                
            } catch (e) {
                console.error("All sound play attempts failed:", e);
            }
        }
        
        // KEYBOARD CONTROL HANDLERS
        function keyPressed() {
            if (keyCode === LEFT_ARROW) {
                soldier.left = true;
                soldier.right = false;
                return false;
            } else if (keyCode === RIGHT_ARROW) {
                soldier.right = true;
                soldier.left = false;
                return false;
            } else if (keyCode === UP_ARROW && !soldier.is_jump) {
                soldier.is_jump = true;
                return false;
            } else if (keyCode === DOWN_ARROW) {
                soldier.down = true;
                return false;
            } else if (keyCode === 32) { // Space key
                if (shoot === 0) {
                    createCircles();
                }
                return false;
            }
        }
        
        function keyReleased() {
            if (keyCode === LEFT_ARROW) {
                soldier.left = false;
                return false;
            } else if (keyCode === RIGHT_ARROW) {
                soldier.right = false;
                return false;
            } else if (keyCode === DOWN_ARROW) {
                soldier.down = false;
                return false;
            }
        }
        
        function draw() {
            if (!gameStarted) return;
            
            // Draw background
            image(gridImg, 0, 0, width, height);
            
            // Update bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].draw();
                
                // Remove finished bullets
                if (bullets[i].isFinished()) {
                    bullets.splice(i, 1);
                }
            }
            
            // Movement logic
            soldier.move();
            
            // Handle shoot cooldown
            if (shoot > 0) {
                shoot += 1;
            }
            if (shoot > 3) {
                shoot = 0;
            }
            
            // Draw character
            soldier.draw();
        }
        
        function windowResized() {
            // Resize canvas maintaining aspect ratio
            if (windowWidth / windowHeight > W_WIDTH / W_HEIGHT) {
                resizeCanvas(windowHeight * (W_WIDTH / W_HEIGHT), windowHeight);
            } else {
                resizeCanvas(windowWidth, windowWidth * (W_HEIGHT / W_WIDTH));
            }
            
            // Reposition mobile controls
            if (gameStarted) {
                leftButton.position(20, height - 70);
                rightButton.position(width - 70, height - 70);
                upButton.position(width/2 - 25, height - 140);
                downButton.position(width/2 - 25, height - 70);
                
                // Adjust sound button
                const soundBtn = document.getElementById('soundButton');
                soundBtn.style.bottom = '140px';
            }
        }
        
        // Additional handler to help with iOS audio
        function touchStarted() {
            unlockAudio();
            return false;
        }
        
        // Mouse click handler (for sound activation)
        function mousePressed() {
            unlockAudio();
            return false;
        }
    </script>
</body>
</html>
