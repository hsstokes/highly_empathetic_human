<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Animated Soldier</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
        }
        canvas {
            display: block;
        }
        #startOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #startButton {
            padding: 20px 40px;
            font-size: 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .control-button {
            position: absolute;
            width: 80px; /* Larger size */
            height: 80px; /* Larger size */
            background-color: rgba(255,255,255,0.5); /* More visible */
            border: 3px solid rgba(0,0,0,0.3); /* Visible border */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px; /* Larger font */
            color: #333; /* Darker text */
            user-select: none;
            -webkit-user-select: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Add shadow for depth */
        }
        .control-button:active {
            background-color: rgba(200,200,200,0.7); /* Visual feedback */
        }
        #soundStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }
        /* Instructions overlay for mobile */
        #mobileInstructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.6);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
            z-index: 90;
            max-width: 80%;
            transition: opacity 0.5s;
        }
        .hide-after {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="startOverlay">
        <button id="startButton">TAP TO START</button>
    </div>
    <div id="soundStatus">Sound: Initializing...</div>
    <div id="mobileInstructions">
        Use the control buttons to move and shoot.<br>
        This message will disappear in a few seconds.
    </div>

    <script>
        // Game variables
        let walkRight = [];
        let walkLeft = [];
        let gridImg;
        let bulletSound, hitSound;
        let bullets = [];
        let shoot = 0;
        let gameStarted = false;
        let soundsLoaded = false;
        let touchControls = false;
        let soundInitialized = false;
        
        // Mobile controls
        let leftButton, rightButton, upButton, downButton, fireButton;
        
        // Canvas dimensions
        const W_WIDTH = 600;
        const W_HEIGHT = 600;
        
        // Player class (matches your Python class)
        class Player {
            constructor(x, y, width, height) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.vel = 4;
                this.is_jump = false;
                this.jump_count = 10;
                this.left = false;
                this.right = false;
                this.up = false;
                this.down = false;
                this.walkCount = 0;
                this.standing = true;
                this.last_direction = "right";
                this.hitbox = {
                    x: this.x + 75,
                    y: this.y + 75,
                    width: this.width - 150,
                    height: this.height - 150
                };
            }
            
            draw() {
                let frames;
                if (this.right || this.last_direction === "right") {
                    frames = walkRight;
                } else {
                    frames = walkLeft;
                }
                
                if (this.walkCount >= frames.length) {
                    this.walkCount = 0;
                }
                
                // Use raw canvas API for multiply blend mode
                let ctx = drawingContext;
                ctx.save();
                ctx.globalCompositeOperation = 'multiply';
                ctx.globalAlpha = 0.9; // Equivalent to set_alpha(230)
                
                // Draw the frame at exact dimensions
                ctx.drawImage(frames[this.walkCount].canvas, this.x, this.y, this.width, this.height);
                
                // Restore canvas state
                ctx.restore();
                
                this.walkCount += 1;
                if (this.walkCount >= frames.length) {
                    this.walkCount = 0;
                }
                
                // Update hitbox with current position
                this.hitbox = {
                    x: this.x + 75,
                    y: this.y + 75,
                    width: this.width - 150,
                    height: this.height - 150
                };
            }
        }
        
        // Projectile class (matches your Python class)
        class Projectile {
            constructor(x, y, radius, colour, direction) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.colour = colour;
                this.direction = direction;
                this.vel = 8 * direction;
            }
            
            draw() {
                fill(this.colour);
                noStroke();
                circle(this.x, this.y, this.radius * 2);
            }
        }
        
        // Preload assets
        function preload() {
            // Load background
            gridImg = loadImage('images/grid_img.jpeg');
            
            // Load soldier images
            for (let i = 1; i <= 6; i++) {
                walkRight.push(loadImage(`soldier/${i}.png`));
                walkLeft.push(loadImage(`soldier/L${i}.png`));
            }
            
            // Simplified sound loading - no complex error handling
            soundFormats('mp3', 'ogg');
            bulletSound = loadSound('sounds/Bulletsound.mp3');
            hitSound = loadSound('sounds/Hit.mp3');
        }
        
        function setup() {
            // Create canvas matching game dimensions
            let canvas;
            if (windowWidth / windowHeight > W_WIDTH / W_HEIGHT) {
                // Screen is wider than game aspect ratio
                canvas = createCanvas(windowHeight * (W_WIDTH / W_HEIGHT), windowHeight);
            } else {
                // Screen is taller than game aspect ratio
                canvas = createCanvas(windowWidth, windowWidth * (W_HEIGHT / W_WIDTH));
            }
            
            // Create soldier
            soldier = new Player(50, 250, 250, 250);
            
            // Always enable touch controls on mobile
            touchControls = true;
            
            // Set up start button
            document.getElementById('startButton').addEventListener('click', startGame);
            document.getElementById('startButton').addEventListener('touchstart', function(e) {
                startGame();
                e.preventDefault();
            });
            
            // Enable sound status display
            const soundStatus = document.getElementById('soundStatus');
            soundStatus.style.display = 'block';
            
            // Create mobile control elements
            createMobileControls();
            
            frameRate(12); // Match your Pygame frame rate
            
            // Create AudioContext manually to help with sound issues
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!window.audioContext) {
                try {
                    window.audioContext = new AudioContext();
                } catch(e) {
                    console.error("Could not create AudioContext:", e);
                }
            }
        }
        
        function createMobileControls() {
            const buttonSize = min(width, height) / 6; // Larger buttons
            
            // Create control buttons
            leftButton = {
                x: buttonSize, 
                y: height - buttonSize * 2,
                size: buttonSize * 1.5,
                pressed: false,
                element: createControlButton('â†', buttonSize, height - buttonSize * 2)
            };
            
            rightButton = {
                x: buttonSize * 3.5, 
                y: height - buttonSize * 2,
                size: buttonSize * 1.5,
                pressed: false,
                element: createControlButton('â†’', buttonSize * 3.5, height - buttonSize * 2)
            };
            
            upButton = {
                x: buttonSize * 2.25, 
                y: height - buttonSize * 3.5,
                size: buttonSize * 1.5,
                pressed: false,
                element: createControlButton('â†‘', buttonSize * 2.25, height - buttonSize * 3.5)
            };
            
            downButton = {
                x: buttonSize * 2.25, 
                y: height - buttonSize * 0.5,
                size: buttonSize * 1.5,
                pressed: false,
                element: createControlButton('â†“', buttonSize * 2.25, height - buttonSize * 0.5)
            };
            
            fireButton = {
                x: width - buttonSize * 2, 
                y: height - buttonSize * 2,
                size: buttonSize * 2,
                pressed: false,
                element: createControlButton('ðŸ”«', width - buttonSize * 2, height - buttonSize * 2)
            };
            
            // Hide controls until game starts
            hideControls();
        }
        
        function createControlButton(symbol, x, y) {
            const button = createElement('div', symbol);
            button.class('control-button');
            button.position(x, y);
            document.body.appendChild(button.elt);
            return button;
        }
        
        function hideControls() {
            leftButton.element.style('display', 'none');
            rightButton.element.style('display', 'none');
            upButton.element.style('display', 'none');
            downButton.element.style('display', 'none');
            fireButton.element.style('display', 'none');
        }
        
        function showControls() {
            leftButton.element.style('display', 'flex');
            rightButton.element.style('display', 'flex');
            upButton.element.style('display', 'flex');
            downButton.element.style('display', 'flex');
            fireButton.element.style('display', 'flex');
            
            // Set up touch handlers
            setupMobileTouchHandlers();
            
            // Show instructions temporarily
            const instructions = document.getElementById('mobileInstructions');
            instructions.style.opacity = 1;
            
            // Hide instructions after 5 seconds
            setTimeout(() => {
                instructions.classList.add('hide-after');
            }, 5000);
        }
        
        function setupMobileTouchHandlers() {
            // Left button
            leftButton.element.elt.addEventListener('touchstart', function(e) {
                leftButton.pressed = true;
                e.preventDefault();
            });
            leftButton.element.elt.addEventListener('touchend', function() {
                leftButton.pressed = false;
            });
            
            // Right button
            rightButton.element.elt.addEventListener('touchstart', function(e) {
                rightButton.pressed = true;
                e.preventDefault();
            });
            rightButton.element.elt.addEventListener('touchend', function() {
                rightButton.pressed = false;
            });
            
            // Up button
            upButton.element.elt.addEventListener('touchstart', function(e) {
                upButton.pressed = true;
                e.preventDefault();
            });
            upButton.element.elt.addEventListener('touchend', function() {
                upButton.pressed = false;
            });
            
            // Down button
            downButton.element.elt.addEventListener('touchstart', function(e) {
                downButton.pressed = true;
                e.preventDefault();
            });
            downButton.element.elt.addEventListener('touchend', function() {
                downButton.pressed = false;
            });
            
            // Fire button
            fireButton.element.elt.addEventListener('touchstart', function(e) {
                if (shoot === 0) {
                    fireBullet();
                    shoot = 1;
                }
                e.preventDefault();
            });
        }
        
        function startGame() {
            // Remove overlay
            document.getElementById('startOverlay').style.display = 'none';
            
            // Resume AudioContext if suspended
            if (window.audioContext && window.audioContext.state === 'suspended') {
                window.audioContext.resume();
            }
            
            // Simple sound initialization - no multiple attempts
            initSounds();
            
            // Show mobile controls
            showControls();
            
            // Start the game
            gameStarted = true;
        }
        
        function initSounds() {
            // Update sound status
            document.getElementById('soundStatus').textContent = 'Sound: Initializing...';
            
            try {
                // Try to unlock the audio context
                if (window.audioContext && window.audioContext.state === 'suspended') {
                    window.audioContext.resume();
                }
                
                // Play and immediately stop both sounds to initialize them
                if (bulletSound && typeof bulletSound.play === 'function') {
                    bulletSound.play();
                    bulletSound.stop();
                }
                
                if (hitSound && typeof hitSound.play === 'function') {
                    hitSound.play();
                    hitSound.stop();
                }
                
                soundsLoaded = true;
                soundInitialized = true;
                document.getElementById('soundStatus').textContent = 'Sound: Ready';
            } catch(e) {
                console.error("Sound initialization failed:", e);
                document.getElementById('soundStatus').textContent = 'Sound: Error';
            }
        }
        
        function fireBullet() {
            // Play both sounds when firing - this is what the user wants
            if (soundsLoaded) {
                if (window.audioContext && window.audioContext.state === 'suspended') {
                    window.audioContext.resume();
                }
                
                bulletSound.play();
                hitSound.play(); // Play hit sound when firing regardless of hitting target
            }
            
            // Determine direction based on soldier facing
            const direction = (soldier.right || soldier.last_direction === "right") ? 1 : -1;
            
            // Create new bullet
            if (bullets.length < 5) {
                bullets.push(new Projectile(
                    soldier.x + soldier.width / 2,
                    soldier.y + soldier.height / 2,
                    6, 
                    color(0, 100, 0), // dark green
                    direction
                ));
            }
        }
        
        function draw() {
            if (!gameStarted) return;
            
            // Draw background
            image(gridImg, 0, 0, width, height);
            
            // Update bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].x += bullets[i].vel;
                
                // Remove bullets that are off-screen
                if (bullets[i].x < 0 || bullets[i].x > width) {
                    bullets.splice(i, 1);
                    continue;
                }
                
                bullets[i].draw();
            }
            
            // Handle keyboard and touch input
            let moved = false;
            
            if ((keyIsDown(LEFT_ARROW) || leftButton.pressed) && soldier.x > 0) {
                soldier.x -= soldier.vel;
                soldier.left = true;
                soldier.right = false;
                soldier.up = false;
                soldier.down = false;
                soldier.standing = false;
                soldier.last_direction = "left";
                moved = true;
            } 
            else if ((keyIsDown(RIGHT_ARROW) || rightButton.pressed) && soldier.x < width - soldier.width) {
                soldier.x += soldier.vel;
                soldier.right = true;
                soldier.left = false;
                soldier.up = false;
                soldier.down = false;
                soldier.standing = false;
                soldier.last_direction = "right";
                moved = true;
            }
            
            // Handle jumping mechanics
            if (!soldier.is_jump) {
                // Start jump if UP is pressed and not already jumping
                if ((keyIsDown(UP_ARROW) || upButton.pressed)) {
                    soldier.is_jump = true;
                    soldier.right = false;
                    soldier.left = false;
                    soldier.up = true;
                    soldier.down = false;
                    soldier.standing = false;
                    moved = true;
                }
                // Handle DOWN movement when not jumping
                else if ((keyIsDown(DOWN_ARROW) || downButton.pressed) && soldier.y < height - soldier.height) {
                    soldier.y += soldier.vel;
                    soldier.down = true;
                    soldier.up = false;
                    soldier.left = false;
                    soldier.right = false;
                    soldier.standing = false;
                    moved = true;
                }
            } else {
                // Handle jumping physics
                if (soldier.jump_count >= -10) {
                    const neg = soldier.jump_count < 0 ? -1 : 1;
                    soldier.y -= (soldier.jump_count ** 2) * neg * 0.5;
                    soldier.jump_count -= 1;
                    moved = true;
                } else {
                    soldier.is_jump = false;
                    soldier.jump_count = 10;
                }
            }
            
            if (!moved) {
                soldier.standing = true;
            }
            
            // Handle space key for shooting (desktop)
            if (keyIsDown(32) && shoot === 0) { // 32 is space key
                fireBullet();
                shoot = 1;
            }
            
            // Handle shoot cooldown
            if (shoot > 0) {
                shoot += 1;
            }
            if (shoot > 3) {
                shoot = 0;
            }
            
            // Draw soldier
            soldier.draw();
        }
        
        function windowResized() {
            // Resize canvas maintaining aspect ratio
            if (windowWidth / windowHeight > W_WIDTH / W_HEIGHT) {
                resizeCanvas(windowHeight * (W_WIDTH / W_HEIGHT), windowHeight);
            } else {
                resizeCanvas(windowWidth, windowWidth * (W_HEIGHT / W_WIDTH));
            }
            
            // Reposition mobile controls
            if (gameStarted) {
                const buttonSize = min(width, height) / 6;
                
                leftButton.x = buttonSize;
                leftButton.y = height - buttonSize * 2;
                leftButton.element.position(leftButton.x, leftButton.y);
                
                rightButton.x = buttonSize * 3.5;
                rightButton.y = height - buttonSize * 2;
                rightButton.element.position(rightButton.x, rightButton.y);
                
                upButton.x = buttonSize * 2.25;
                upButton.y = height - buttonSize * 3.5;
                upButton.element.position(upButton.x, upButton.y);
                
                downButton.x = buttonSize * 2.25;
                downButton.y = height - buttonSize * 0.5;
                downButton.element.position(downButton.x, downButton.y);
                
                fireButton.x = width - buttonSize * 2;
                fireButton.y = height - buttonSize * 2;
                fireButton.element.position(fireButton.x, fireButton.y);
            }
        }
        
        // Additional handler to help with iOS audio
        function touchStarted() {
            if (window.audioContext && window.audioContext.state === 'suspended') {
                window.audioContext.resume();
            }
        }
    </script>
</body>
</html>
